{\rtf1\ansi\ansicpg1252\cocoartf2709
\cocoatextscaling0\cocoaplatform0{\fonttbl\f0\fnil\fcharset0 Menlo-Regular;}
{\colortbl;\red255\green255\blue255;\red93\green103\blue113;\red255\green255\blue255;\red152\green163\blue172;
\red129\green140\blue148;\red171\green117\blue245;\red80\green236\blue130;\red254\green231\blue88;\red122\green214\blue255;
\red253\green149\blue80;\red252\green80\blue109;\red129\green139\blue148;}
{\*\expandedcolortbl;;\cssrgb\c43998\c47926\c51793;\cssrgb\c100000\c100000\c100000\c0;\cssrgb\c65979\c69906\c72961;
\cssrgb\c57735\c61662\c64727;\cssrgb\c73183\c55947\c97054;\cssrgb\c35583\c92464\c58259;\cssrgb\c99820\c91538\c41609;\cssrgb\c53915\c86893\c100000;
\cssrgb\c99904\c65345\c38553;\cssrgb\c99935\c41464\c49977;\cssrgb\c57647\c61569\c64706;}
\margl1440\margr1440\vieww11520\viewh8400\viewkind0
\deftab720
\pard\pardeftab720\partightenfactor0

\f0\fs24 \cf2 \cb3 \expnd0\expndtw0\kerning0
\
\pard\pardeftab720\partightenfactor0
\cf4 Authentication-methods\cf2 \
# This is a version of the main.py file found in ../../../server/main.py without authentication.\cf5 \
\pard\pardeftab720\partightenfactor0
\cf2 # Copy and paste this into the main file at ../../../server/main.py if you choose to use no authentication for your retrieval plugin.\cf5 \
\pard\pardeftab720\partightenfactor0
\cf6 from\cf5  typing \cf6 import\cf5  Optional\
\cf6 import\cf5  uvicorn\
\cf6 from\cf5  fastapi \cf6 import\cf5  FastAPI, File, Form, HTTPException, Body, UploadFile\
\cf6 from\cf5  fastapi.staticfiles \cf6 import\cf5  StaticFiles\
\cf6 from\cf5  loguru \cf6 import\cf5  logger\
\
\cf6 from\cf5  models.api \cf6 import\cf5  (\
    DeleteRequest,\
    DeleteResponse,\
    QueryRequest,\
    QueryResponse,\
    UpsertRequest,\
    UpsertResponse,\
)\
\cf6 from\cf5  datastore.factory \cf6 import\cf5  get_datastore\
\cf6 from\cf5  services.file \cf6 import\cf5  get_document_from_file\
\
\cf6 from\cf5  models.models \cf6 import\cf5  DocumentMetadata, Source\
\
\
app = \cf4 FastAPI()\cf5 \
app.\cf4 mount(\cf7 "/.well-known"\cf4 , StaticFiles(directory\cf5 =\cf7 ".well-known"\cf4 ), name\cf5 =\cf7 "static"\cf4 )\cf5 \
\
\pard\pardeftab720\partightenfactor0
\cf2 # Create a sub-application, in order to access just the query endpoints in the OpenAPI schema, found at http://0.0.0.0:8000/sub/openapi.json when the app is running locally\cf5 \
sub_app = \cf4 FastAPI(\cf5 \
\pard\pardeftab720\partightenfactor0
\cf4     title\cf5 =\cf7 "Retrieval Plugin API"\cf4 ,\cf5 \
\cf4     description\cf5 =\cf7 "A retrieval API for querying and filtering documents based on natural language queries and metadata"\cf4 ,\cf5 \
\cf4     version\cf5 =\cf7 "1.0.0"\cf4 ,\cf5 \
\cf4     servers\cf5 =\cf4 [\{\cf7 "url"\cf4 : \cf7 "https://your-app-url.com"\cf4 \}],\cf5 \
\cf4 )\cf5 \
app.\cf4 mount(\cf7 "/sub"\cf4 , sub_app)\cf5 \
\
\
\pard\pardeftab720\partightenfactor0
\cf8 @app.post\cf4 (\cf5 \
\pard\pardeftab720\partightenfactor0
\cf4     \cf7 "/upsert-file"\cf4 ,\cf5 \
\cf4     response_model\cf5 =\cf4 UpsertResponse,\cf5 \
\cf4 )\cf5 \
\cf6 async\cf5  \cf6 def\cf5  \cf8 upsert_file\cf5 (\
    \cf4 file\cf5 : UploadFile = \cf4 File(...)\cf5 ,\
    \cf4 metadata\cf5 : Optional\cf4 [\cf9 str\cf4 ]\cf5  = \cf4 Form(\cf10 None\cf4 )\cf5 ,\
):\
    \cf6 try\cf5 :\
        metadata_obj = (\
            DocumentMetadata.\cf4 parse_raw(metadata)\cf5 \
            \cf6 if\cf5  metadata\
            \cf6 else\cf5  \cf4 DocumentMetadata(source\cf5 =\cf4 Source.file)\cf5 \
        )\
    \cf6 except\cf5 :\
        metadata_obj = \cf4 DocumentMetadata(source\cf5 =\cf4 Source.file)\cf5 \
\
    document = \cf6 await\cf5  \cf4 get_document_from_file(file, metadata_obj)\cf5 \
\
    \cf6 try\cf5 :\
        ids = \cf6 await\cf5  datastore.\cf4 upsert([document])\cf5 \
        \cf6 return\cf5  \cf4 UpsertResponse(ids\cf5 =\cf4 ids)\cf5 \
    \cf6 except\cf5  \cf9 Exception\cf5  \cf6 as\cf5  e:\
        logger.\cf4 error(e)\cf5 \
        \cf6 raise\cf5  \cf4 HTTPException(status_code\cf5 =\cf9 500\cf4 , detail\cf5 =\cf6 f\cf7 "str(\cf4 \{e\}\cf7 )"\cf4 )\cf5 \
\
\
\pard\pardeftab720\partightenfactor0
\cf8 @app.post\cf4 (\cf5 \
\pard\pardeftab720\partightenfactor0
\cf4     \cf7 "/upsert"\cf4 ,\cf5 \
\cf4     response_model\cf5 =\cf4 UpsertResponse,\cf5 \
\cf4 )\cf5 \
\cf6 async\cf5  \cf6 def\cf5  \cf8 upsert\cf5 (\
    \cf4 request\cf5 : UpsertRequest = \cf4 Body(...)\cf5 ,\
):\
    \cf6 try\cf5 :\
        ids = \cf6 await\cf5  datastore.\cf4 upsert(request.documents)\cf5 \
        \cf6 return\cf5  \cf4 UpsertResponse(ids\cf5 =\cf4 ids)\cf5 \
    \cf6 except\cf5  \cf9 Exception\cf5  \cf6 as\cf5  e:\
        logger.\cf4 error(e)\cf5 \
        \cf6 raise\cf5  \cf4 HTTPException(status_code\cf5 =\cf9 500\cf4 , detail\cf5 =\cf7 "Internal Service Error"\cf4 )\cf5 \
\
\
\pard\pardeftab720\partightenfactor0
\cf8 @app.post\cf4 (\cf5 \
\pard\pardeftab720\partightenfactor0
\cf4     \cf7 "/query"\cf4 ,\cf5 \
\cf4     response_model\cf5 =\cf4 QueryResponse,\cf5 \
\cf4 )\cf5 \
\cf6 async\cf5  \cf6 def\cf5  \cf8 query_main\cf5 (\
    \cf4 request\cf5 : QueryRequest = \cf4 Body(...)\cf5 ,\
):\
    \cf6 try\cf5 :\
        results = \cf6 await\cf5  datastore.\cf4 query(\cf5 \
\cf4             request.queries,\cf5 \
\cf4         )\cf5 \
        \cf6 return\cf5  \cf4 QueryResponse(results\cf5 =\cf4 results)\cf5 \
    \cf6 except\cf5  \cf9 Exception\cf5  \cf6 as\cf5  e:\
        logger.\cf4 error(e)\cf5 \
        \cf6 raise\cf5  \cf4 HTTPException(status_code\cf5 =\cf9 500\cf4 , detail\cf5 =\cf7 "Internal Service Error"\cf4 )\
\
\
\
\
no-auth\
\
\pard\pardeftab720\partightenfactor0
\cf5 \{\
  \cf6 "schema_version"\cf5 : \cf7 "v1"\cf5 ,\
  \cf6 "name_for_model"\cf5 : \cf7 "retrieval"\cf5 ,\
  \cf6 "name_for_human"\cf5 : \cf7 "Retrieval Plugin"\cf5 ,\
  \cf6 "description_for_model"\cf5 : \cf7 "Plugin for searching through the user's documents (such as files, emails, and more) to find answers to questions and retrieve relevant information. Use it whenever a user asks something that might be found in their personal information."\cf5 ,\
  \cf6 "description_for_human"\cf5 : \cf7 "Search through your documents."\cf5 ,\
  \cf6 "auth"\cf5 : \{\
    \cf6 "type"\cf5 : \cf7 "none"\cf5 \
  \},\
  \cf6 "api"\cf5 : \{\
    \cf6 "type"\cf5 : \cf7 "openapi"\cf5 ,\
    \cf6 "url"\cf5 : \cf7 "https://your-app-url.com/.well-known/openapi.yaml"\cf5 \
  \},\
  \cf6 "logo_url"\cf5 : \cf7 "https://your-app-url.com/.well-known/logo.png"\cf5 ,\
  \cf6 "contact_email"\cf5 : \cf7 "hello@contact.com"\cf5 , \
  \cf6 "legal_info_url"\cf5 : \cf7 "hello@legal.com"\cf5 \
\}\
\
\pard\pardeftab720\partightenfactor0
\cf4 oauth\
\
\pard\pardeftab720\partightenfactor0
\cf5 \{\
  \cf6 "schema_version"\cf5 : \cf7 "v1"\cf5 ,\
  \cf6 "name_for_model"\cf5 : \cf7 "retrieval"\cf5 ,\
  \cf6 "name_for_human"\cf5 : \cf7 "Retrieval Plugin"\cf5 ,\
  \cf6 "description_for_model"\cf5 : \cf7 "Plugin for searching through the user's documents (such as files, emails, and more) to find answers to questions and retrieve relevant information. Use it whenever a user asks something that might be found in their personal information."\cf5 ,\
  \cf6 "description_for_human"\cf5 : \cf7 "Search through your documents."\cf5 ,\
  \cf6 "auth"\cf5  : \{\
    \cf6 "type"\cf5 :\cf7 "oauth"\cf5 ,\
    \cf6 "client_url"\cf5 :\cf7 "e.g. https://<your domain>/oauth/v2/authorize"\cf5 ,\
    \cf6 "authorization_url"\cf5 :\cf7 "e.g. https://<your domain>/api/oauth.v2.access"\cf5 ,\
    \cf6 "scope"\cf5 :\cf7 "search:read"\cf5 ,\
    \cf6 "authorization_content_type"\cf5 :\cf7 "application/x-www-form-urlencoded"\cf5 ,\
    \cf6 "verification_tokens"\cf5 :\{\
      \cf6 "openai"\cf5 :\cf7 "<token from add plugin flow from the ChatGPT UI>"\cf5 \
    \}\
  \},\
  \cf6 "api"\cf5 :\{\
    \cf6 "url"\cf5 : \cf7 "https://your-app-url.com/.well-known/openapi.yaml"\cf5 ,\
    \cf6 "has_user_authentication"\cf5 :\cf10 true\cf5 ,\
    \cf6 "type"\cf5 :\cf7 "openapi"\cf5 \
  \},\
  \cf6 "logo_url"\cf5 : \cf7 "https://your-app-url.com/.well-known/logo.png"\cf5 ,\
  \cf6 "contact_email"\cf5 : \cf7 "hello@contact.com"\cf5 , \
  \cf6 "legal_info_url"\cf5 : \cf7 "hello@legal.com"\cf5 \
\}\
\
\pard\pardeftab720\partightenfactor0
\cf4 service-http\
\
\pard\pardeftab720\partightenfactor0
\cf5 \{\
  \cf6 "schema_version"\cf5 : \cf7 "v1"\cf5 ,\
  \cf6 "name_for_model"\cf5 : \cf7 "retrieval"\cf5 ,\
  \cf6 "name_for_human"\cf5 : \cf7 "Retrieval Plugin"\cf5 ,\
  \cf6 "description_for_model"\cf5 : \cf7 "Plugin for searching through the user's documents (such as files, emails, and more) to find answers to questions and retrieve relevant information. Use it whenever a user asks something that might be found in their personal information."\cf5 ,\
  \cf6 "description_for_human"\cf5 : \cf7 "Search through your documents."\cf5 ,\
  \cf6 "auth"\cf5 :\{\
    \cf6 "type"\cf5 :\cf7 "service_http"\cf5 ,\
    \cf6 "authorization_type"\cf5 :\cf7 "bearer"\cf5 ,\
    \cf6 "verification_tokens"\cf5 :\{\
      \cf6 "openai"\cf5 :\cf7 "<token from add plugin flow from the ChatGPT UI>"\cf5 \
    \}\
  \},\
  \cf6 "api"\cf5 :\{\
    \cf6 "url"\cf5 : \cf7 "https://your-app-url.com/.well-known/openapi.yaml"\cf5 ,\
    \cf6 "has_user_authentication"\cf5 :\cf10 false\cf5 ,\
    \cf6 "type"\cf5 :\cf7 "openapi"\cf5 \
  \},\
  \cf6 "logo_url"\cf5 : \cf7 "https://your-app-url.com/.well-known/logo.png"\cf5 ,\
  \cf6 "contact_email"\cf5 : \cf7 "hello@contact.com"\cf5 , \
  \cf6 "legal_info_url"\cf5 : \cf7 "hello@legal.com"\cf5 \
\}\
\
\pard\pardeftab720\partightenfactor0
\cf4 \
user-http\
\
\pard\pardeftab720\partightenfactor0
\cf5 \{\
  \cf6 "schema_version"\cf5 : \cf7 "v1"\cf5 ,\
  \cf6 "name_for_model"\cf5 : \cf7 "retrieval"\cf5 ,\
  \cf6 "name_for_human"\cf5 : \cf7 "Retrieval Plugin"\cf5 ,\
  \cf6 "description_for_model"\cf5 : \cf7 "Plugin for searching through the user's documents (such as files, emails, and more) to find answers to questions and retrieve relevant information. Use it whenever a user asks something that might be found in their personal information."\cf5 ,\
  \cf6 "description_for_human"\cf5 : \cf7 "Search through your documents."\cf5 ,\
  \cf6 "auth"\cf5 : \{\
    \cf6 "type"\cf5 : \cf7 "user_http"\cf5 ,\
    \cf6 "authorization_type"\cf5 : \cf7 "bearer"\cf5 \
  \},\
  \cf6 "api"\cf5 : \{\
    \cf6 "type"\cf5 : \cf7 "openapi"\cf5 ,\
    \cf6 "url"\cf5 : \cf7 "https://your-app-url.com/.well-known/openapi.yaml"\cf5 ,\
    \cf6 "has_user_authentication"\cf5 : \cf10 false\cf5 \
  \},\
  \cf6 "logo_url"\cf5 : \cf7 "https://your-app-url.com/.well-known/logo.png"\cf5 ,\
  \cf6 "contact_email"\cf5 : \cf7 "hello@contact.com"\cf5 , \
  \cf6 "legal_info_url"\cf5 : \cf7 "hello@legal.com"\cf5 \
\}\
\pard\pardeftab720\partightenfactor0
\cf4 \
\
Docker setup for mutiple providers but not for AWS or GCP \
\
milvus \
\
\pard\pardeftab720\partightenfactor0
\cf11 version\cf5 : \cf7 '3.5'\cf5 \
\
\cf11 services\cf5 :\
  \cf11 etcd\cf5 :\
    \cf11 container_name\cf5 : \cf7 milvus-etcd\cf5 \
    \cf11 image\cf5 : \cf7 quay.io/coreos/etcd:v3.5.0\cf5 \
    \cf11 environment\cf5 :\
      - \cf7 ETCD_AUTO_COMPACTION_MODE=revision\cf5 \
      - \cf7 ETCD_AUTO_COMPACTION_RETENTION=1000\cf5 \
      - \cf7 ETCD_QUOTA_BACKEND_BYTES=4294967296\cf5 \
      - \cf7 ETCD_SNAPSHOT_COUNT=50000\cf5 \
    \cf11 volumes\cf5 :\
      - \cf7 $\{DOCKER_VOLUME_DIRECTORY:-.\}/volumes/etcd:/etcd\cf5 \
    \cf11 command\cf5 : \cf7 etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd\cf5 \
\
  \cf11 minio\cf5 :\
    \cf11 container_name\cf5 : \cf7 milvus-minio\cf5 \
    \cf11 image\cf5 : \cf7 minio/minio:RELEASE.2023-03-20T20-16-18Z\cf5 \
    \cf11 environment\cf5 :\
      \cf11 MINIO_ACCESS_KEY\cf5 : \cf7 minioadmin\cf5 \
      \cf11 MINIO_SECRET_KEY\cf5 : \cf7 minioadmin\cf5 \
    \cf11 volumes\cf5 :\
      - \cf7 $\{DOCKER_VOLUME_DIRECTORY:-.\}/volumes/minio:/minio_data\cf5 \
    \cf11 command\cf5 : \cf7 minio server /minio_data\cf5 \
    \cf11 healthcheck\cf5 :\
      \cf11 test\cf5 : [\cf7 "CMD"\cf5 , \cf7 "curl"\cf5 , \cf7 "-f"\cf5 , \cf7 "http://localhost:9000/minio/health/live"\cf5 ]\
      \cf11 interval\cf5 : \cf7 30s\cf5 \
      \cf11 timeout\cf5 : \cf7 20s\cf5 \
      \cf11 retries\cf5 : \cf9 3\cf5 \
\
  \cf11 standalone\cf5 :\
    \cf11 container_name\cf5 : \cf7 milvus-standalone\cf5 \
    \cf11 image\cf5 : \cf7 milvusdb/milvus:v2.2.5\cf5 \
    \cf11 command\cf5 : [\cf7 "milvus"\cf5 , \cf7 "run"\cf5 , \cf7 "standalone"\cf5 ]\
    \cf11 environment\cf5 :\
      \cf11 ETCD_ENDPOINTS\cf5 : \cf7 etcd:2379\cf5 \
      \cf11 MINIO_ADDRESS\cf5 : \cf7 minio:9000\cf5 \
    \cf11 volumes\cf5 :\
      - \cf7 $\{DOCKER_VOLUME_DIRECTORY:-.\}/volumes/milvus:/var/lib/milvus\cf5 \
    \cf11 ports\cf5 :\
      - \cf7 "19530:19530"\cf5 \
      - \cf7 "9091:9091"\cf5 \
    \cf11 depends_on\cf5 :\
      - \cf7 "etcd"\cf5 \
      - \cf7 "minio"\cf5 \
\
\cf11 networks\cf5 :\
  \cf11 default\cf5 :\
    \cf11 name\cf5 : \cf7 milvus\cf5 \
\
\
Qdrant\
\
\cf11 services\cf5 :\
  \cf11 retrieval-app\cf5 :\
    \cf11 build\cf5 :\
      \cf11 context\cf5 : \cf7 ../../../\cf5 \
      \cf11 dockerfile\cf5 : \cf7 Dockerfile\cf5 \
    \cf11 image\cf5 : \cf7 openai/chatgpt-retrieval-plugin\cf5 \
    \cf11 ports\cf5 :\
      - \cf7 "80:80"\cf5 \
    \cf11 depends_on\cf5 :\
      - \cf7 qdrant\cf5 \
    \cf11 environment\cf5 :\
      \cf11 DATASTORE\cf5 : \cf7 "qdrant"\cf5 \
      \cf11 QDRANT_URL\cf5 : \cf7 "http://qdrant"\cf5 \
      \cf11 BEARER_TOKEN\cf5 : \cf7 "$\{BEARER_TOKEN\}"\cf5 \
      \cf11 OPENAI_API_KEY\cf5 : \cf7 "$\{OPENAI_API_KEY\}"\cf5 \
  \cf11 qdrant\cf5 :\
    \cf11 image\cf5 : \cf7 qdrant/qdrant:v1.0.3\cf5 \
\
\
Redis\
\
\cf11 version\cf5 : \cf7 "3.9"\cf5 \
\
\cf11 services\cf5 :\
  \cf11 redis\cf5 :\
    \cf11 image\cf5 : \cf7 redis/redis-stack-server:latest\cf5 \
    \cf11 ports\cf5 :\
      - \cf7 "6379:6379"\cf5 \
    \cf11 volumes\cf5 :\
        - \cf7 redis_data:/data\cf5 \
    \cf11 healthcheck\cf5 :\
      \cf11 test\cf5 : [\cf7 "CMD"\cf5 , \cf7 "redis-cli"\cf5 , \cf7 "-h"\cf5 , \cf7 "localhost"\cf5 , \cf7 "-p"\cf5 , \cf7 "6379"\cf5 , \cf7 "ping"\cf5 ]\
      \cf11 interval\cf5 : \cf7 2s\cf5 \
      \cf11 timeout\cf5 : \cf7 1m30s\cf5 \
      \cf11 retries\cf5 : \cf9 5\cf5 \
      \cf11 start_period\cf5 : \cf7 5s\cf5 \
\
\cf11 volumes\cf5 :\
  \cf11 redis_data\cf5 :\
\pard\pardeftab720\partightenfactor0
\cf12 \cb1 \
}